#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

[[ -n $LUVIT_VERSION ]] || LUVIT_VERSION="0.7.0"

BUILD_DIR=$1
CACHE_DIR=$2

cd $BUILD_DIR

LUVM_URL="https://github.com/dvv/luvit-luvm/archive/master.tar.gz"
echo "-----> Fetching luvm from $LUVM_URL "
mkdir -p /tmp/luvm
pushd /tmp/luvm

wget $LUVIT_URL
tar xzvf master.tar.gz
cat luvit-luvm-master/luvm.sh > /etc/profile.d/luvm.sh
source /etc/profile.d/luvm.sh

popd
rm -rf /tmp/luvm

echo "-----> Installing luvit $LUVIT_VERSION "

luvm install $LUVIT_VERSION

echo "export LUVIT_VERSION=$LUVIT_VERSION" >> /etc/profile.d/luvm.sh
echo 'luvm use $LUVIT_VERSION' >> /etc/profile.d/luvm.sh
