#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

[[ -n $LUVIT_VERSION ]] || LUVIT_VERSION="0.7.0"

BUILD_DIR=$1
CACHE_DIR=$2

cd $BUILD_DIR

LUVM_URL="https://github.com/dvv/luvit-luvm/archive/master.tar.gz"
echo "-----> Fetching luvm from $LUVM_URL "
mkdir -p /tmp/luvm
pushd /tmp/luvm

wget $LUVM_URL
tar xzvf master.tar.gz
source luvit-luvm-master/luvm.sh 
echo "-----> Installing luvit $LUVIT_VERSION "

luvm install $LUVIT_VERSION
luvm use $LUVIT_VERSION

mkdir -p /app/bin
ln -s $(which luvit) /app/bin/luvit

popd

rm -rf /tmp/luvm
